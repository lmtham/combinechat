<button id="start-recording">üé§ Start Recording</button>
<button id="stop-recording" disabled>‚èπ Stop</button>
<p id="transcription"></p>

<script>
const deepgramUrl = "wss://api.deepgram.com/v1/listen?access_token=4563a2200b751d0d6b02a2e358d0f05ff21a81b5";
const n8nWebhookUrl = "YOUR_N8N_WEBHOOK_URL";

let mediaRecorder;
let socket;

document.getElementById("start-recording").addEventListener("click", async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const audioContext = new AudioContext();
    const source = audioContext.createMediaStreamSource(stream);
    const processor = audioContext.createScriptProcessor(4096, 1, 1);

    socket = new WebSocket(deepgramUrl);
    socket.onopen = () => console.log("Connected to Deepgram");
    socket.onmessage = async (event) => {
        const data = JSON.parse(event.data);
        if (data.channel?.alternatives[0]?.transcript) {
            document.getElementById("transcription").innerText = data.channel.alternatives[0].transcript;
            sendToN8N(data.channel.alternatives[0].transcript);
        }
    };

    processor.onaudioprocess = (e) => {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(e.inputBuffer.getChannelData(0));
        }
    };

    source.connect(processor);
    processor.connect(audioContext.destination);
    
    mediaRecorder = { stream, audioContext, processor, source };  
    document.getElementById("start-recording").disabled = true;
    document.getElementById("stop-recording").disabled = false;
});

document.getElementById("stop-recording").addEventListener("click", () => {
    if (mediaRecorder) {
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        mediaRecorder.processor.disconnect();
        mediaRecorder.source.disconnect();
        socket.close();
    }
    document.getElementById("start-recording").disabled = false;
    document.getElementById("stop-recording").disabled = true;
});

async function sendToN8N(transcript) {
    await fetch(n8nWebhookUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: transcript }),
    });
}
</script>
